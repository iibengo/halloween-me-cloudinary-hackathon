---
import Layout from "../layouts/Layout.astro";
import { CldUploadWidget } from "astro-cloudinary";
import ImageList from "../components/vue/image-list/image-list.vue";
import HowTo from "../components/vue/how-to/how-to.vue";
---

<Layout title="Generador Halloween - Cloudinary Hackathon">
  <main class="min-h-screen bg-orange-900 flex flex-col items-center justify-center p-4">
    <div class="max-w-md w-full bg-black rounded-lg shadow-2xl overflow-hidden">
      <div class="p-6 space-y-6">
        <h1 class="text-3xl font-extrabold text-orange-500 text-left">
          Generador de imágenes Halloween
        </h1>

        <CldUploadWidget
          id="upload-widget"
          uploadPreset="upload-unsigned-images"
          options={{
            sources: ["local"],
            multiple: false,
            maxFiles: 1,
            language: "es",
            text: {
              es: {
                or: "O",
                menu: {
                  files: "Subir desde tu dispositivo",
                },
                local: {
                  browse: "Seleccionar",
                  dd_title_single: "Arrastra tu imagen aquí",
                },
              },
            },
          }}
        >
        <button
          class="flex items-center justify-center mt-6 w-full py-3 px-6 bg-orange-500 hover:bg-orange-600 text-white font-bold rounded-full transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-orange-400 focus:ring-opacity-50"
        >
          <img src="assets/icon/pumpkin.svg" alt="Pumpkin Icon" class="w-6 h-6 mr-2" />
          <span class="mr-2">HALLOWEEN ME</span>
          <img src="assets/icon/pumpkin.svg" alt="Pumpkin Icon" class="w-6 h-6 mr-2" />
        </button>
        </CldUploadWidget>
        <p class="mt-4 text-1-xl text-orange-500 text-left">
          Últimos <span class="font-bold">HalloweenMe's</span>
        </p>
        <!-- Renderizamos el componente ImageList que ahora maneja las imágenes -->
        <ImageList client:only />

        <HowTo client:only />
      </div>
    </div>
  </main>

  <script lang="ts" is:inline>
    const widget = document.getElementById("upload-widget");

    if (widget) {
      widget.addEventListener("clduploadwidget:success", async (e) => {
        const publicId = e.detail.info.public_id;
        await fetch("/api/saveImageService", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            cloudinaryId: publicId,
            original: true,
            cloudinaryUrl: ""
          })
        });

        window.location.href = `/photo?cid=${publicId}`;
      });
    }
  </script>
</Layout>
